# 实验报告lab0.5&lab1

## 练习目的
通过GDB调试QEMU模拟的RISC-V计算机，验证从加电到执行应用程序第一条指令（跳转至0x80200000）的过程，了解硬件加电后的指令和功能。

## 实验环境
- QEMU
- GDB
- RISC-V架构的相关代码

## 实验过程

1. **启动模拟环境**：
   使用以下命令启动QEMU并进入调试模式：
   ```bash
   make debug
   ```
2. **连接GDB**：
   在另一个终端中，启动GDB并连接到QEMU：
   ```bash
   riscv32-unknown-elf-gdb <your_program.elf>
   ```

3. **设置断点**：
   在目标地址设置断点（0x80200000）：
   ```gdb
   break *0x80200000
   ```
4. **运行程序**：
   在GDB中运行程序，直至断点：
   ```gdb
   continue
   ```

5. **查看指令**：
   显示0x80000000处的10条指令，以了解加电后的执行流程：
   ```gdb
   x/10i 0x80000000
   ```

6. **单步执行**：
   使用单步执行指令，逐条检查执行情况：
   ```gdb
   si
   ```




## 指令分析




1. **`0x80000000: csrr a6, mhartid`**：
   - 功能：读取当前硬件线程的ID（mhartid），存入寄存器a6，标识当前执行的硬件线程。

2. **`0x80000004: bgtz a6, 0x80000108`**：
   - 功能：如果寄存器a6的值大于零，跳转到地址0x80000108，控制程序流向。

3. **`0x80000008: auipc t0, 0x0`**：
   - 功能：将立即数加到程序计数器的高位，t0寄存器用于计算后续指令的地址。

4. **`0x8000000c: addi t0, t0, 1032`**：
   - 功能：将1032加到t0寄存器的值。

5. **`0x80000010: auipc t1, 0x0`**：
   - 功能：类似于前面的auipc指令，为寄存器t1计算后续指令的地址。

6. **`0x80000014: addi t1, t1, -16`**：
   - 功能：将t1寄存器的值减少16。

7. **`0x80000018: 0x62b023`**：
   - 功能：为`sw`指令，将寄存器中的数据存储到内存中。

8. **`0x8000001c: auipc t0, 0x0`**：
   - 功能：再次计算t0的地址，准备执行后续指令。

9. **`0x80000020: addi t0, t0, 1020`**：
   - 功能：将1020加到t0寄存器的值，设置另一个数据结构的基地址。



## 结论
在本次实验中，通过GDB调试成功验证了RISC-V从加电到执行第一条指令的过程，初步学习了使用GDB调试RISC-V的基本方法，为后续实验奠定基础。











# (扩展练习Challenge3：完善异常中断.2)
## 实验目的
**EXPERIMENT_OBJECTIVE** := 本实验旨在实现对RISC-V架构中触发的非法指令异常的捕获与处理，  
特别是针对 `mret` 指令的非法使用，以及其他非法指令的处理。  
同时，输出相关异常信息以便调试与验证。

## 实验环境
**EXPERIMENT_ENVIRONMENT** := 硬件平台：QEMU Virt Machine  
开发环境：riscv64-ucore-labcodes  
编译工具：RISC-V GCC Toolchain

## 实验步骤
扩展练习Challenge3：完善异常中断
1. 在 `kern/trap/trap.c` 文件中，添加对 `mret` 指令的非法指令处理逻辑：  
   ```c
   case CAUSE_ILLEGAL_INSTRUCTION: {
       uint32_t illegal_inst = *(uint32_t *)(tf->epc);
       if (illegal_inst == 0x30200073) {
           cprintf("Exception type: Illegal mret instruction\n");
           cprintf("Exception address: 0x%08x\n", tf->epc);
           tf->epc += 4;
       } else {
           cprintf("Exception type: Illegal instruction\n");
           cprintf("Exception address: 0x%08x\n", tf->epc);
           tf->epc += 4;
       }
       break;
   }
   ```


